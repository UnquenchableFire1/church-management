<!doctype html>
<html>
	<head>
		<meta charset='utf-8'>
		<meta name='viewport' content='width=device-width,initial-scale=1'>
	<title>Admin - Sermons</title>
		<link rel='stylesheet' href='styles.css'>
	</head>
	<body>
		<header class="site-header">
			<div class="nav">
				<div class="brand"><div class="logo">CP</div><div>The Church of Pentecost</div></div>
						<nav class="nav-links" role="menu" aria-hidden="true">
							<button class="nav-close" aria-label="Close menu">‚úï</button>
							<a href="/" role="menuitem">Home</a>
							<a href="/admin.html" role="menuitem">Dashboard</a>
							<button id="adminLogout" class="btn secondary" role="menuitem" style="margin-left:16px">Logout</button>
						</nav>
						<!-- mobile nav toggle -->
						<button id="navToggle" class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">‚ò∞</button>
				</div>
		</header>
		<main class='container'>
			<div class='card'>
						<nav class="tabs" id="adminTabs">
							<a class="tab" href="admin_members.html"><span class="icon">üë§</span>Members</a>
							<a class="tab" href="admin_ministries.html"><span class="icon">üè¢</span>Ministries</a>
							<a class="tab" href="admin_sermons.html"><span class="icon">üìñ</span>Sermons</a>
							<a class="tab" href="admin_events.html"><span class="icon">üìÖ</span>Events</a>
							<a class="tab" href="admin_announcements.html"><span class="icon">üì¢</span>Announcements</a>
						</nav>

						<button class="admin-side-toggle" id="sideToggle" title="Toggle panel">‚ò∞</button>
						<div class="admin-layout">
							<aside class="admin-side card" id="adminSide">
									<div class="muted">Sermons / Media</div>
									<div class='form' style="margin-top:10px">
										<!-- Upload form -->
										<div id="uploadArea">
											<h4>Upload Sermon / Media</h4>
											<input id="sermonTitle" placeholder="Title (optional)">
											<input id="sermonFile" type="file" accept="video/*,audio/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" required>
											<div style="margin-top:8px">
												<button id="uploadBtn" class="btn">Upload</button>
											</div>
										</div>
									</div>
								</aside>

					<section class="admin-main">
						<div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
							<input id='search' placeholder='Search by title'>
							<button id='sbtn' class='btn'>Search</button>
						</div>
						<div id='list'></div>
						<div id='pager' class='muted' style='margin-top:12px'></div>
					</section>
				</div>
			</div>
			</main>
			<script>
				document.getElementById('adminLogout').onclick = function() {
					localStorage.removeItem('adminToken');
					window.location = '/login.html';
				};
			</script>

			<script>
				// Accessible mobile nav: open/close, focus trap, auto-close on link click, Escape-to-close, and hamburger rotation
				(() => {
					const nav = document.querySelector('.nav-links');
					const toggle = document.getElementById('navToggle');
					const closeBtn = nav && nav.querySelector('.nav-close');
					let lastFocused = null;

					if(!nav || !toggle) return;

					const focusableSelector = 'a[href], button:not([disabled]), input, [tabindex]:not([tabindex="-1"])';

					function openNav(){
						lastFocused = document.activeElement;
						nav.classList.add('open');
						nav.setAttribute('aria-hidden','false');
						toggle.setAttribute('aria-expanded','true');
						toggle.classList.add('open');
						// move focus to first focusable element inside nav
						const first = nav.querySelector(focusableSelector);
						if(first) first.focus();
						document.addEventListener('keydown', trapTab);
						document.addEventListener('keydown', handleEsc);
					}

					function closeNav(){
						nav.classList.remove('open');
						nav.setAttribute('aria-hidden','true');
						toggle.setAttribute('aria-expanded','false');
						toggle.classList.remove('open');
						document.removeEventListener('keydown', trapTab);
						document.removeEventListener('keydown', handleEsc);
						if(lastFocused) lastFocused.focus();
					}

					function handleEsc(e){ if(e.key === 'Escape' || e.key === 'Esc'){ closeNav(); } }

					function trapTab(e){
						if(e.key !== 'Tab') return;
						const focusables = Array.from(nav.querySelectorAll(focusableSelector)).filter(el => el.offsetParent !== null);
						if(focusables.length === 0) return;
						const first = focusables[0];
						const last = focusables[focusables.length -1];
						if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
						else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
					}

					// Toggle handler
					toggle.addEventListener('click', ()=>{
						if(nav.classList.contains('open')) closeNav(); else openNav();
					});

					// Close button inside nav
					if(closeBtn) closeBtn.addEventListener('click', closeNav);

					// Auto-close when any nav link/menuitem is activated
					nav.addEventListener('click', (ev) => {
						const target = ev.target.closest('[role="menuitem"]');
						if(target && nav.classList.contains('open')){
							// Let links/buttons perform their action, then close
							setTimeout(closeNav, 0);
						}
					});
				})();
			</script>

			<script>
				// Highlight active tab automatically
				(()=>{
					const tabs = document.querySelectorAll('#adminTabs .tab');
					tabs.forEach(tab => {
						if(window.location.pathname.endsWith(tab.getAttribute('href'))){
							tab.classList.add('active');
						} else {
							tab.classList.remove('active');
						}
					});
				})();
				// Collapsible side panel for mobile
				const side = document.getElementById('adminSide');
				const toggle = document.getElementById('sideToggle');
				toggle.onclick = () => {
					side.classList.toggle('collapsed');
				};
			const token = localStorage.getItem('adminToken');
			// Load sermons list
			async function loadSermons(search=''){
				const q = new URLSearchParams({search}).toString();
				const res = await fetch('/api/admin/sermons?'+q, { headers: { Authorization: 'Bearer '+token } });
				if(!res.ok){ document.getElementById('list').innerHTML = '<div class="muted">Unable to load sermons (unauthorized?)</div>'; return; }
				const items = await res.json();
				document.getElementById('list').innerHTML = items.map(s => `
					<div class='card'>
						<strong>${s.title || s.originalName}</strong>
						<div class='muted'>${s.mimeType || ''}</div>
						<div style="margin-top:8px">
							<a class='btn' href="/uploads/sermons/${s.filename}" target="_blank">Download / View</a>
							<button class='btn' onclick="delSermon(${s.id})">Delete</button>
						</div>
					</div>
				`).join('');
			}
			window.load = () => loadSermons();

			// Upload handler
			document.getElementById('uploadBtn').onclick = async () => {
				const fileEl = document.getElementById('sermonFile');
				if(!fileEl.files || fileEl.files.length===0){ alert('Please choose a file'); return; }
				const fd = new FormData();
				fd.append('file', fileEl.files[0]);
				const title = document.getElementById('sermonTitle').value.trim();
				if(title) fd.append('title', title);
				const res = await fetch('/api/admin/sermons', { method: 'POST', headers: { Authorization: 'Bearer '+token }, body: fd });
				if(res.ok){ alert('Uploaded'); document.getElementById('sermonTitle').value=''; fileEl.value=''; loadSermons(); }
				else { const txt = await res.text(); alert('Upload failed: '+txt); }
			};

			// Delete
			window.delSermon = async (id) => { if(!confirm('Delete this sermon?')) return; const res = await fetch('/api/admin/sermons/'+id, { method: 'DELETE', headers: { Authorization: 'Bearer '+token } }); if(res.ok) loadSermons(); else alert('Delete failed'); };

			document.getElementById('sbtn').onclick = () => loadSermons(document.getElementById('search').value);

			loadSermons();
		</script>
	</body>
</html>